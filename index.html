<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control MQTT - ESP8266</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { color: #333; text-align: center; margin-bottom: 10px; font-size: 28px; }

        .status-container {
            background: #f7f7f7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status { display: inline-flex; align-items: center; gap: 10px; font-weight: 600; font-size: 16px; }

        .status-dot { width: 12px; height: 12px; border-radius: 50%; animation: pulse 2s infinite; }

        .status.connected .status-dot { background: #4CAF50; }
        .status.disconnected .status-dot { background: #f44336; animation: none; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .form-group { margin-bottom: 20px; }

        label { display: block; color: #555; font-weight: 600; margin-bottom: 10px; font-size: 14px; }

        input[type="text"] {
            width: 100%; padding: 15px; border: 2px solid #e0e0e0;
            border-radius: 12px; font-size: 16px;
            transition: all 0.3s ease; outline: none;
        }

        input[type="text"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-send {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 12px;
            font-size: 18px; font-weight: 700; cursor: pointer;
            transition: all 0.3s ease; text-transform: uppercase;
        }

        .btn-send:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,0.4); }
        .btn-send:disabled { background: #ccc; cursor: not-allowed; }
        .btn-send.sending { background: #4CAF50; }

        .notification {
            position: fixed; top: 20px; right: 20px;
            background: white; padding: 20px 30px;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none; align-items: center; gap: 15px;
            animation: slideIn 0.3s ease; z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.show { display: flex; }
        .notification.success { border-left: 4px solid #4CAF50; }
        .notification.error { border-left: 4px solid #f44336; }

        .notification-icon { font-size: 24px; }
        .notification-message { font-weight: 600; color: #333; }

        .broker-info {
            background: #f0f4ff; border-left: 4px solid #667eea;
            padding: 12px 15px; margin-bottom: 25px;
            border-radius: 8px; font-size: 13px; color: #555;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéÅ Enviar mensaje al regalo</h1>

        <div class="status-container">
            <div class="status disconnected" id="status">
                <span class="status-dot"></span>
                <span id="status-text">Desconectado</span>
            </div>
        </div>

        <div class="broker-info">
            <strong>Broker:</strong> <span id="broker-display">broker.emqx.io:8084</span><br>
            <strong>T√≥pico:</strong> <span id="topic-display">/regalo/mensaje</span>
        </div>

        <div class="form-group">
            <label for="message">Escribe tu mensaje:</label>
            <input type="text" id="message" placeholder="Escribe aqu√≠ tu mensaje..." autocomplete="off">
        </div>

        <button class="btn-send" id="sendBtn" onclick="sendMessage()">Enviar Mensaje</button>
    </div>

    <div class="notification" id="notification">
        <span class="notification-icon" id="notificationIcon"></span>
        <span class="notification-message" id="notificationMessage"></span>
    </div>

<script>

// ==================== CONFIG MQTT ============================
const BROKER_HOST = "broker.emqx.io";
const BROKER_PORT = 8084;    
const MQTT_TOPIC  = "/regalo/mensaje";

const WS_URL = `wss://${BROKER_HOST}:${BROKER_PORT}/mqtt`;
const CLIENT_ID = "web_" + Math.random().toString(16).substr(2, 8);

let client;
let isConnected = false;

const statusElement = document.getElementById('status');
const statusText = document.getElementById('status-text');
const messageInput = document.getElementById('message');
const sendBtn = document.getElementById('sendBtn');
const notification = document.getElementById('notification');
const notificationIcon = document.getElementById('notificationIcon');
const notificationMessage = document.getElementById('notificationMessage');

// ==================== INICIAR MQTT ============================
function initMQTT() {
    try {
        client = new Paho.MQTT.Client(WS_URL, CLIENT_ID);

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        client.connect({
            timeout: 5,
            useSSL: true,
            cleanSession: true,
            onSuccess: onConnect,
            onFailure: onFailure
        });

    } catch (err) {
        showNotification("Error al iniciar MQTT", "error");
    }
}

function onConnect() {
    isConnected = true;
    updateStatus(true);
}

function onFailure() {
    updateStatus(false);
    setTimeout(initMQTT, 4000);
}

function onConnectionLost() {
    updateStatus(false);
    setTimeout(initMQTT, 4000);
}

function onMessageArrived(msg) {
    console.log("Mensaje recibido ‚Üí", msg.payloadString);
}

// ==================== ENVIAR MENSAJE ============================
function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return showNotification("Escribe un mensaje", "error");
    if (!isConnected) return showNotification("No conectado", "error");

    // ‚ö† IMPORTANTE: agregar "MQTT:" para que EL ESP LO GUARDE
    const finalMsg = "MQTT:" + text;

    try {
        const message = new Paho.MQTT.Message(finalMsg);
        message.destinationName = MQTT_TOPIC;
        client.send(message);

        sendBtn.classList.add("sending");
        setTimeout(() => sendBtn.classList.remove("sending"), 300);

        showNotification("Mensaje enviado ‚úì", "success");
        messageInput.value = "";

    } catch (err) {
        showNotification("Error al enviar", "error");
    }
}

// ==================== UI ============================
function updateStatus(ok) {
    if (ok) {
        statusElement.classList.remove("disconnected");
        statusElement.classList.add("connected");
        statusText.textContent = "Conectado";
        sendBtn.disabled = false;
    } else {
        statusElement.classList.add("disconnected");
        statusText.textContent = "Desconectado";
        sendBtn.disabled = true;
    }
}

function showNotification(text, type) {
    notificationMessage.textContent = text;
    notificationIcon.textContent = type === "success" ? "‚úì" : "‚úó";
    notification.className = "notification show " + type;

    setTimeout(() => notification.classList.remove("show"), 2500);
}

window.onload = initMQTT;

</script>
</body>
</html>
